generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id               Int               @id @default(autoincrement())
  username         String            @unique
  email            String            @unique
  password         String
  fullName         String?
  avatar           String?           @default("default-avatar.jpg")
  bio              String?           @default("")
  coins            Int               @default(0)
  isVip            Boolean           @default(false)
  vipExpiresAt     DateTime?
  role             Role              @default(USER)
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  coinTransactions CoinTransaction[]
  comments         Comment[]
  followers        Follow[]          @relation("Following")
  following        Follow[]          @relation("Followers")
  likes            Like[]
  receivedMessages Message[]         @relation("ReceivedMessages")
  sentMessages     Message[]         @relation("SentMessages")
  notifications    Notification[]
  posts            Post[]
  rooms            UserRoom[]
  createdRooms     Room[]            @relation("CreatedRooms")

  pushSubscriptions PushSubscription[]

  @@map("users")
}

model PushSubscription {
  id        Int      @id @default(autoincrement())
  endpoint  String   @unique
  keys      Json
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@map("push_subscriptions")
}

model Post {
  id            Int            @id @default(autoincrement())
  content       String
  image         String?
  authorId      Int
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  comments      Comment[]
  likes         Like[]
  notifications Notification[] @relation("PostNotifications")
  author        User           @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("posts")
}

model Comment {
  id            Int            @id @default(autoincrement())
  content       String
  image         String?
  postId        Int
  authorId      Int
  createdAt     DateTime       @default(now())
  author        User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  post          Post           @relation(fields: [postId], references: [id], onDelete: Cascade)
  notifications Notification[] @relation("CommentNotifications")

  @@map("comments")
}

model Like {
  id        Int      @id @default(autoincrement())
  postId    Int
  userId    Int
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@map("likes")
}

model Notification {
  id        Int      @id @default(autoincrement())
  type      String
  content   String
  userId    Int
  senderId  Int?
  postId    Int?
  commentId Int?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  comment   Comment? @relation("CommentNotifications", fields: [commentId], references: [id], onDelete: Cascade)
  post      Post?    @relation("PostNotifications", fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Room {
  id        Int        @id @default(autoincrement())
  name      String?
  avatar    String?
  isGroup   Boolean    @default(false)
  createdBy Int?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @default(now()) @updatedAt
  messages  Message[]
  users     UserRoom[]
  creator   User?      @relation("CreatedRooms", fields: [createdBy], references: [id], onDelete: SetNull)

  @@map("rooms")
}

model UserRoom {
  userId   Int
  roomId   Int
  joinedAt DateTime @default(now())
  room     Room     @relation(fields: [roomId], references: [id])
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roomId])
  @@map("user_rooms")
}

model Message {
  id         Int      @id @default(autoincrement())
  content    String? // Made optional because message might be just media
  roomId     Int
  senderId   Int
  receiverId Int?
  mediaUrl   String?
  mediaType  String? // 'image' | 'video'
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt
  isRead     Boolean  @default(false)
  deletedBy  Int[]    @default([])
  isRecalled Boolean  @default(false)
  isEdited   Boolean  @default(false)
  receiver   User?    @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: SetNull)
  room       Room     @relation(fields: [roomId], references: [id])
  sender     User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model Follow {
  followerId  Int
  followingId Int
  follower    User @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  following   User @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@map("follows")
}

model CoinTransaction {
  id        Int      @id @default(autoincrement())
  userId    Int
  amount    Int
  reason    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("coin_transactions")
}

enum Role {
  USER
  VIP
  ADMIN
}
